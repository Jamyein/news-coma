"""PromptEngine - 1-Pass Prompt生成引擎"""

import logging
from src.models import NewsItem, AIConfig

logger = logging.getLogger(__name__)


class PromptEngine:
    """1-Pass Prompt生成引擎"""

    def __init__(self, config: AIConfig):
        self.config = config
        self.scoring_criteria = config.scoring_criteria
        logger.info("PromptEngine初始化完成")
    
    def build_1pass_prompt(self, items: list[NewsItem]) -> str:
        """构建1-pass评分Prompt"""
        news_blocks = [self._format_news_item(item, i) for i, item in enumerate(items, 1)]
        sc = self.scoring_criteria

        return f"""请对以下 {len(items)} 条新闻进行专业评估。

{chr(10).join(news_blocks)}

【任务要求】
对每条新闻完成以下评估：

1. **分类判断**：根据以下标准选择最合适的分类

   【财经】判断标准（符合任一即可）：
   - 涉及公司财报、盈利、营收、股价、市值、IPO、融资、并购
   - 涉及货币政策、利率、汇率、外汇储备、金融监管政策
   - 涉及股票市场、商品价格、大宗商品、期货交易
   - 涉及金融机构、银行、保险、证券业务
   - 涉及宏观经济数据（GDP、通胀、就业等）
   
   典型示例：
   ✅ "标普500企业利润增长" → 财经
   ✅ "丹诺医药港股IPO" → 财经
   ✅ "央行虚拟货币监管通知" → 财经（金融监管）
   ✅ "华润三九净利润34.22亿元" → 财经（财报）
   
   【科技】判断标准（符合任一即可）：
   - 涉及 AI、机器学习、大模型、算法、技术创新
   - 科技公司（SpaceX、OpenAI、苹果等）的技术产品/服务
   - 新技术发布、技术突破、研发进展
   - 涉及网络安全、漏洞、技术架构
   - 涉及新能源技术、电池技术、自动驾驶
   
   典型示例：
   ✅ "Claude Code AI智能体" → 科技
   ✅ "SpaceX火星计划推迟" → 科技
   ✅ "苹果CarPlay接入AI" → 科技
   
   【社会政治】判断标准（符合任一即可）：
   - 涉及政治人物言行、选举、政府决策
   - 涉及社会事件、公共政策（非金融类）、法律法规
   - 涉及国际关系、地缘政治、贸易摩擦
   - 涉及社会民生、教育、医疗政策（非商业类）
   
   典型示例：
   ✅ "特朗普言论引发争议" → 社会政治
   ✅ "美国通过新的教育法案" → 社会政治
   
   边界案例说明：
   ⚠️ "央行虚拟货币监管" → 财经（金融监管属于财经范畴）
   ⚠️ "FDA打击假药" → 财经（市场监管，影响医药行业）

2. **5维度评分**（1-10分）：
   - 重要性（权重{sc.importance*100:.0f}%）：对行业/市场/社会的影响程度
   - 时效性（权重{sc.timeliness*100:.0f}%）：新闻的及时性和当前相关性
   - 技术深度（权重{sc.technical_depth*100:.0f}%）：技术内容的深度和专业性
   - 受众广度（权重{sc.audience_breadth*100:.0f}%）：影响的人群范围
   - 实用性（权重{sc.practicality*100:.0f}%）：对读者的实际参考价值

3. **总分**：加权平均分（保留1位小数）

4. **详细摘要**：3-4句话，必须包含：
   - 第1句：核心事件（发生了什么）
   - 第2句：关键数据/事实（具体数字、时间、主体）
   - 第3-4句：影响分析（对行业、市场或用户的具体影响）
   
   禁止使用的模板化表达：
   - ❌ "对...有重要影响"
   - ❌ "具有很高的时效性"
   - ❌ "值得关注"
   - ❌ "体现了..."
   - ❌ "对...有重要意义"
   - ❌ "时效性强"
   - ❌ "受众广度高"
   
   好的摘要示例：
   ✅ "比特币价格在24小时内暴跌50%，从10万美元跌至5万美元，创2022年以来最大单日跌幅。美联储暗示将继续加息引发市场恐慌，导致加密货币市场集体抛售。分析师警告此次暴跌可能引发连锁反应，投资者需密切关注风险。"

5. **关键要点提取**：生成3-5条核心要点，每条必须包含具体事实和数据：
   - 提取新闻中最关键的事实、数字、公司名称、时间节点
   - 避免空洞的评价性语言，如"影响重大"、"意义重大"
   - 每条要点控制在15-30字，简洁有力
   - 优先包含：金额、百分比、时间、主体、动作
   
   好的要点示例：
   ✅ "比特币24小时跌幅达50%，价格从10万美元跌至5万美元"
   ✅ "创2022年以来最大单日跌幅，主要受美联储加息预期影响"
   ✅ "美联储暗示2025年可能继续加息，引发市场恐慌情绪"
   
   差的要点示例：
   ❌ "对比特币市场有重要影响"
   ❌ "值得关注的市场动态"

【输出格式】JSON数组，每条新闻一个对象：
{{
  "news_index": 1,
  "category": "财经|科技|社会政治",
  "category_confidence": 0.95,
  "importance": 8,
  "timeliness": 9,
  "technical_depth": 7,
  "audience_breadth": 6,
  "practicality": 7,
  "total_score": 7.5,
  "summary": "详细摘要，3-4句话，包含具体事实和数据...",
  "key_points": [
    "要点1：具体事实+数据（15-30字）",
    "要点2：具体事实+数据（15-30字）",
    "要点3：具体事实+数据（15-30字）"
  ]
}}

【重要提醒】
- 摘要和要点必须具体，包含新闻中的实际数据和信息
- 严禁使用模板化、空洞的表述
- 分类要准确，特别是金融监管类新闻应归为财经而非社会政治"""
    
    def _format_news_item(self, item: NewsItem, index: int) -> str:
        """格式化单条新闻"""
        summary = item.summary[:300] if item.summary else "无摘要"
        return f"【新闻 {index}】\n标题: {item.title}\n来源: {item.source}\n摘要: {summary}"
